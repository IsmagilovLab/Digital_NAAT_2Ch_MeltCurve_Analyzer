
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>JUSTINS_NA_ANALYZER_V5_annotated</title><meta name="generator" content="MATLAB 9.2"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2018-09-10"><meta name="DC.source" content="JUSTINS_NA_ANALYZER_V5_annotated.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">VARIABLES FOR EDITING</a></li><li><a href="#3">PROGRAM START HERE</a></li></ul></div><pre class="codeinput">clear;
close <span class="string">all</span>;

<span class="comment">%Automated analyzer for real-time isothermal amplification</span>
<span class="comment">%by Erik Jue, 2018</span>

<span class="comment">%This MATLAB script performs the following functions</span>
<span class="comment">%Loads a 12-bit .tif image sequence for digital LAMP experiment</span>
<span class="comment">%Uses first image frame (low temp) to detect total # wells</span>
<span class="comment">%Uses 2nd to last image frame (end of experiment) to detect positive wells</span>
<span class="comment">%Tracks the intensity of the positive wells over time</span>
<span class="comment">%Applies gaussian smoothing and baseline subtraction</span>
<span class="comment">%Saves the data</span>
<span class="comment">%Repeats for each tiff stack in the folder</span>

<span class="comment">%Requires Bio-Formats 5.8.1 by OME</span>
<span class="comment">%https://www.openmicroscopy.org/bio-formats/</span>
<span class="comment">%Requires Control ZEN Blue and the microscope from MATLAB (ReadImage6D.m) by Sebastian Rhode</span>
<span class="comment">%https://www.mathworks.com/matlabcentral/fileexchange/50079-control-zen-blue-and-the-microscope-from-matlab?focused=6875595&amp;tab=function</span>

<span class="comment">%Notes specific to this data set</span>
<span class="comment">%Used a connectivity of 4 (cardinal directions only) for well detection</span>
<span class="comment">%Ignore last frame since it does not capture the full exposure</span>
<span class="comment">%Sample fluorescence is high at low temp, use this to detect all wells</span>
<span class="comment">%Sample fluorescence decreases with high temp, ignore all heating frames</span>
</pre><h2 id="2">VARIABLES FOR EDITING</h2><pre class="codeinput"><span class="comment">%FOLDER TO ANALYZE, WILL ANALYZE ALL .TIF FILES IT FINDS</span>
folder = <span class="string">'Z:\Path\'</span>; <span class="comment">%'C:\user\data';</span>

<span class="comment">%SAVE LOCATION</span>
saveHere = <span class="string">'Z:\Path\'</span>; <span class="comment">%'C:\user\results\';</span>

<span class="comment">%Adds the trailing \ if applicable</span>
<span class="keyword">if</span> saveHere(end)~=<span class="string">'\'</span>
    saveHere = strcat(saveHere, <span class="string">'\'</span>);
<span class="keyword">end</span>

<span class="comment">%SETTINGS, 1 means on, 0 means off</span>
<span class="comment">%Set to 1 to save images</span>
imageSave = 1;
<span class="comment">%Set to 1 to save summary info to excel file</span>
excelSaveSummary = 1;
<span class="comment">%Set to 1 to save intensity curves to excel file</span>
excelSaveIntensity = 1;

<span class="comment">%baselineAdjust averages the intensities between all frames in between</span>
<span class="comment">%baselineStart and baselineEnd and subtracts this value for all frames</span>
<span class="comment">%Set to 1 to enable background subtraction</span>
baselineAdjust = 1;

<span class="comment">%This is the frame number when the sample loses autofluorescence</span>
<span class="comment">%(i.e. reaches the correct temp) A specific baseline end can be dictated</span>
<span class="comment">%by altering 'baselineEnd'</span>
frameAtTemp = 2;
baselineStart = frameAtTemp;
baselineEnd = 5;

<span class="comment">%slopeAdjust finds the slope between the baselineEnd frame and</span>
<span class="comment">%baselineStart frame and propagates the slope correction for all frames</span>
<span class="comment">%This can be used to account for slow drift of negatives wells</span>
<span class="comment">%Note: do not use if raw data is very noisy</span>
<span class="comment">%Set to 1 to enable background slope correction</span>
slopeAdjust = 0;

<span class="comment">%Well Detection Settings</span>
<span class="comment">%Multi-level thresholding</span>
<span class="comment">%This techniques applies a threshold to detect a set of wells and selects</span>
<span class="comment">%selects wells that fall in the areaBound and majorAxisBound. Multiple</span>
<span class="comment">%rounds of different thresholds are applied to detect a greater number of</span>
<span class="comment">%wells</span>

<span class="comment">%Manually determined threshold levels for first image</span>
im1_thresh = [.07 .08 .09 .1 .11 .12 .13 .14 .15 .175 .2 0.3 0.35 0.4 0.5];

<span class="comment">%Manually determine threshold levels for the masking image</span>
mask_thresh = [.05 .075 .1 .125 .15 .175 .2 .25 .3 .4];

<span class="comment">%lower and upper cutoff for the area of each well</span>
<span class="comment">%Units in # of pixels</span>
areaBound = [4 12];

<span class="comment">%lower and upper cutoff for the major axis of each well (ensures circularity)</span>
majorAxisBound = [2 5];

<span class="comment">%Thresholding is used for automated time-to-positive determination</span>
<span class="comment">%Will calculate ttp after baselineAdjust and slopeAdjust if applicable</span>
threshold = 500;

<span class="comment">%A gaussian filter is used to smooth the intensity curves</span>
<span class="comment">%Set the gaussian window smoothing size</span>
gaussWinSize = 5;

<span class="comment">%Maximum allowable slope to detect</span>
maxSlope = 200;

<span class="comment">%Threshold for the max slope required to call a well positive</span>
maxSlopeThreshold = 150;
</pre><h2 id="3">PROGRAM START HERE</h2><pre class="codeinput"><span class="comment">%Identify all the .tif files</span>
myFiles = dir(fullfile(folder, <span class="string">'*.tif'</span>));

<span class="comment">%For each .tif, run image analysis</span>
<span class="keyword">for</span> a=1:size(myFiles,1)
    <span class="comment">%Generate the specific file name</span>
    baseFileName = myFiles(a).name;
    filename = fullfile(folder, baseFileName);

    <span class="comment">%Load the image into memory</span>
    tifStack=ReadImage6D(filename);
    disp([<span class="string">'Loaded '</span>, filename])

    <span class="comment">%The data file tifStack stores image info in {1} and metadata in {2}</span>
    <span class="comment">%Grab the metadata</span>
    numImages = tifStack{2}.SizeZ;
    <span class="comment">%For our images, %Y pixels are actually X pixels</span>
    xpixels = tifStack{2}.SizeY;
    ypixels = tifStack{2}.SizeX;

    <span class="comment">%tifStack stores image info {1} in the format below</span>
      <span class="comment">%1 = Series</span>
      <span class="comment">%2 = SizeC</span>
      <span class="comment">%3 = SizeZ</span>
      <span class="comment">%4 = SizeT</span>
      <span class="comment">%5 = SizeX</span>
      <span class="comment">%6 = SizeY</span>
    <span class="comment">%Depending on how the .tif was generated, image # may be in slot 3 or 4</span>

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%COUNT TOTAL WELLS USING 1ST IMAGE</span>
    <span class="comment">%Matlab does not natively support 12-bit, convert to 16-bit</span>
    im1 = cast(16*squeeze(tifStack{1}(1,1,1,1,:,:)), <span class="string">'uint16'</span>);

    <span class="comment">%Detect all wells for the first image</span>
    im1_bestMask = zeros(size(im1));
    <span class="keyword">for</span> k = 1:size(im1_thresh,2)
        bwthresh = imbinarize(im1, im1_thresh(k));

        <span class="comment">%Apply area filter</span>
        areaFilter = bwpropfilt(bwthresh, <span class="string">'Area'</span>, areaBound, 4);
        <span class="comment">%Apply major axis filter</span>
        majorAxisFilter = bwpropfilt(areaFilter, <span class="string">'MajorAxisLength'</span>, majorAxisBound, 4);

        im1_bestMask = im1_bestMask + majorAxisFilter;
    <span class="keyword">end</span>
    im1_bestMask = im1_bestMask~=0;

    <span class="comment">%Calculate the total number of wells using the mask</span>
    im1_result = bwconncomp(im1_bestMask, 4);
    totalNumWells = im1_result.NumObjects;


    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%COUNT POSITIVE WELLS USING 2ND TO LAST IMAGE</span>
    maskIm = cast(16*squeeze(tifStack{1}(1,1,numImages-1,1,:,:)), <span class="string">'uint16'</span>);

    bestMask = zeros(size(im1));
    <span class="keyword">for</span> k = 1:size(mask_thresh, 2)
        bwthresh = imbinarize(maskIm, mask_thresh(k));

        <span class="comment">%Apply area filter</span>
        areaFilter = bwpropfilt(bwthresh, <span class="string">'Area'</span>, areaBound, 4);
        <span class="comment">%Apply major axis filter</span>
        majorAxisFilter = bwpropfilt(areaFilter, <span class="string">'MajorAxisLength'</span>, majorAxisBound, 4);

        bestMask = bestMask + majorAxisFilter;
    <span class="keyword">end</span>
    bestMask = bestMask~=0;

    <span class="comment">%Generate the mask to use for all images</span>
    labeledmask= bwconncomp(bestMask, 4);
    disp(<span class="string">'Mask found, begin avg intensity calculations'</span>)


    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%FIND INTENSITY OF ALL POSITIVE WELLS OVER TIME</span>

    <span class="comment">%Call regionprops to count the number of positive wells</span>
    resultTemp = regionprops(labeledmask, bestMask, <span class="string">'MeanIntensity'</span>);
    numWells = size(resultTemp, 1);

    <span class="comment">%Initialize matrix to track all intensity curves</span>
    intensity = zeros(numImages-1, numWells);

    <span class="comment">%Loop through all images and find the avg intensity of each well</span>
    <span class="keyword">for</span> i = 1:numImages-1
        <span class="keyword">if</span> mod(i,10)==0
            disp(strcat(<span class="string">'Calculating image #'</span>, num2str(i)))
        <span class="keyword">end</span>

        current_im_u16 = cast(squeeze(tifStack{1}(1,1,i,1,:,:)), <span class="string">'uint16'</span>);

        result = regionprops(labeledmask, current_im_u16, <span class="string">'MeanIntensity'</span>, <span class="string">'Area'</span>);
        intensity(i, :) = cat(1, result.MeanIntensity);
    <span class="keyword">end</span>

    <span class="comment">%Pull out the area for each well</span>
    wellArea = zeros(numWells, 1);
    wellArea(:) = cat(1, result.Area);
    disp(<span class="string">'All well intensities found'</span>)

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%DATA SMOOTHING, BKGND CORRECTION, AND SLOPE CORRECTION</span>
    <span class="comment">%Apply heuristically determined moving average window filter</span>
    smooth = smoothdata(intensity, <span class="string">'gaussian'</span>, gaussWinSize);

    <span class="comment">%Background average subtraction</span>
    baseline = zeros(1, numWells);
    baselineData = intensity;

    <span class="keyword">if</span> baselineAdjust==1
        <span class="comment">%Average the intensities between baselineStart and baselineEnd for</span>
        <span class="comment">%each well</span>
        <span class="keyword">for</span> i = 1:numWells
            baseline(i) = mean(smooth(baselineStart:baselineEnd, i));
        <span class="keyword">end</span>

        <span class="comment">%Subtract the baseline for each well</span>
        <span class="keyword">for</span> i = 1:numWells
            <span class="keyword">for</span> j = 1:numImages-1
               baselineData(j,i) = smooth(j,i) - baseline(i);
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">%Adjust the slope from baseline</span>
    <span class="keyword">if</span> slopeAdjust==1
        <span class="keyword">for</span> i = 1:size(baselineData,1)
            slope = (baselineData(baselineEnd, i) - baselineData(baselineStart, i)) / (baselineEnd - baselineStart + 1);
            baselineSlope = linspace(0, (numImages-1)*slope, numImages);
            baselineSlope = baselineSlope - (((baselineEnd+baselineStart)/2)-1)*slope;

            baselineData(i, :) = baselineData(i, :) - baselineSlope(i);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    disp(<span class="string">'Finished data smoothing'</span>)

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%DATA PROCESSING</span>

    <span class="comment">%Determine which wells cross the intensity threshold</span>
    <span class="comment">%Initialize an array to hold time-to-positive values for each well</span>
    ttp_thresh = zeros(numWells,1 );

    <span class="comment">%Do not count any time-to-positives before sample has reached temp</span>
    <span class="keyword">for</span> i=frameAtTemp:numImages-1
        <span class="keyword">for</span> j=1:numWells
            <span class="comment">%Record the first frame that a well crosses the threshold</span>
            <span class="keyword">if</span> (baselineData(i,j)&gt;threshold &amp;&amp; ttp_thresh(j)==0)
                ttp_thresh(j) = i;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">%Generate new array that only contains wells that cross the threshold</span>
    ttp_thresh_clean = ttp_thresh(ttp_thresh&gt;0);

    <span class="comment">%Generate array of number of wells on per frame</span>
    Intensity_Histogram = zeros(numImages,1);
    <span class="keyword">for</span> i=1:numImages
        Intensity_Histogram(i) = sum(ttp_thresh_clean(:)==i);
    <span class="keyword">end</span>

    <span class="comment">%Find the max slope for each well</span>
    fast_Slope = zeros(numWells, 1);
    <span class="keyword">for</span> p = 1:numWells
        fastestSlope = max(diff(baselineData(:,p)));
        <span class="comment">%Ignores extremely high slopes that are imaging artifacts</span>
        <span class="keyword">if</span> fastestSlope &lt; maxSlope
            fast_Slope(p) = fastestSlope;
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">%Determine which wells cross the intensity AND slope thresholds</span>
    ttp_thresh_slope = ttp_thresh(fast_Slope&gt;maxSlopeThreshold);
    ttp_thresh_slope_clean = ttp_thresh_slope(ttp_thresh_slope&gt;0);

    Intensity_Slope_Histogram = zeros(numImages, 1);
    <span class="keyword">for</span> i=1:numImages
        Intensity_Slope_Histogram(i) = sum(ttp_thresh_slope_clean(:)==i);
    <span class="keyword">end</span>

    <span class="comment">%Determine which wells cross slope threshold</span>
    baselineDiffData = diff(baselineData,1,1);

    ttp_slopeOnly = zeros(numWells,1);
    <span class="keyword">for</span> q=frameAtTemp:numImages-2
        <span class="keyword">for</span> r=1:numWells
            <span class="comment">%Record the first frame that a well crosses the threshold</span>
            <span class="keyword">if</span> (baselineDiffData(q,r)&gt;maxSlopeThreshold &amp;&amp; ttp_slopeOnly(r)==0)
                ttp_slopeOnly(r) = q;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">%Generate new array that only contains wells that cross the threshold</span>
    ttp_slopeOnly_clean = ttp_slopeOnly(ttp_slopeOnly&gt;0);

    Slope_Histogram = zeros(numImages-1, 1);
    <span class="keyword">for</span> i=1:numImages-1
        Slope_Histogram(i) = sum(ttp_slopeOnly_clean(:)==i);
    <span class="keyword">end</span>

    <span class="comment">%Find the max intensity of each positive well</span>
    endIntensity = zeros(numWells, 1);
    <span class="keyword">for</span> m = 1:numWells
        endIntensity(m) = (baselineData(numImages-1,m));
    <span class="keyword">end</span>

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%SAVE DATA</span>
    <span class="comment">%Break the filename into parts</span>
    [filepath, name, ext] = fileparts(filename);

    <span class="comment">%Create a folder to save the results</span>
    <span class="keyword">if</span> imageSave == 1
        disp(<span class="string">'Saving Images'</span>)
        mkdir(strcat(saveHere, <span class="string">'Results_'</span>, name));
    <span class="keyword">end</span>

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%Plot the generation of the masks</span>
    figure(1)
    subplot(2,2,1);
    imshow(im1);
    title(<span class="string">'First Image'</span>)

    subplot(2,2,2);
    imshow(im1_bestMask);
    title(<span class="string">'Well Counting'</span>)

    subplot(2,2,3);
    imshow(maskIm);
    title(<span class="string">'Masking Image'</span>)

    subplot(2,2,4);
    imshow(bestMask);
    title(<span class="string">'Final Mask'</span>)

    <span class="keyword">if</span> imageSave == 1
        saveas(gcf,strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\Thresholding'</span>),<span class="string">'png'</span>)
    <span class="keyword">end</span>

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%%Plot baselined intensities over time</span>
    figure(2)

    <span class="comment">%Downsample here to shown fewer curves</span>
    plot(baselineData(:, :));

    <span class="comment">%Set the plot axes</span>
    axis([0 numImages -100 1000]);
    title([name <span class="string">' Corrected Well Intensity'</span>]);
    xlabel(<span class="string">'Frame Number (2 per minute)'</span>);
    ylabel(<span class="string">'RFU'</span>);

    <span class="keyword">if</span> imageSave == 1
        saveas(gcf,strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\BaselineIntensity'</span>),<span class="string">'png'</span>)
    <span class="keyword">end</span>

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%%Plot derivative of baseline over time</span>
    figure(3)

    <span class="comment">%Downsample here to shown fewer curves</span>
    plot(baselineDiffData(:, :));

    <span class="comment">%Set the plot axes</span>
    axis([0 numImages -30 200]);
    title([name <span class="string">' Corrected Derivative'</span>]);
    xlabel(<span class="string">'Frame Number (2 per minute)'</span>);
    ylabel(<span class="string">'Delta RFU'</span>);

    <span class="keyword">if</span> imageSave == 1
        saveas(gcf,strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\BaselineDeriv'</span>),<span class="string">'png'</span>)
    <span class="keyword">end</span>

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%%PLOT HISTOGRAM AND CDF FOR WELLS THAT CROSS INTENSITY THRESH</span>

    <span class="comment">%Only plot if the are wells that turned positive.</span>
    <span class="keyword">if</span> ttp_thresh_clean &gt; 1
        figure(4)
        h=histcounts(ttp_thresh_clean, max(max(ttp_thresh_clean)) - min(min(ttp_thresh_clean)) + 1);

        <span class="comment">%LineSpec Settings: line, marker, and colour</span>
        plot(min(min(ttp_thresh_clean)):max(max(ttp_thresh_clean)), h, <span class="string">'b'</span>);
        axis([0 numImages -inf inf]);
        title([name <span class="string">' Intensity Histogram'</span>])
        ylabel(<span class="string">'Wells Turning On'</span>)
        xlabel(<span class="string">'Frame Number (2 per Minute)'</span>)
        <span class="keyword">if</span> imageSave == 1
            saveas(gcf,strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\Intensity_Hist'</span>),<span class="string">'png'</span>)
        <span class="keyword">end</span>

        <span class="comment">%%Plot ttp CDF</span>
        figure(5)
        intensity_cdfhandle = cdfplot(ttp_thresh_clean);
        title([name <span class="string">' Intensity CDF, '</span>, num2str(size(ttp_thresh_clean,1)), <span class="string">' Wells'</span>])
        xlabel(<span class="string">'Frame Number (2 per Minute)'</span>)
        set(intensity_cdfhandle, <span class="string">'LineStyle'</span>, <span class="string">'-'</span>, <span class="string">'Color'</span>, <span class="string">'r'</span>);

        <span class="keyword">if</span> imageSave == 1
            saveas(gcf,strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\Intensity_CDF'</span>),<span class="string">'png'</span>)
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%%PLOT HISTOGRAM AND CDF FOR WELLS THAT CROSS INTENSITY AND SLOPE THRESH</span>
    <span class="keyword">if</span> ttp_thresh_slope_clean &gt; 1
        figure(6)
        h=histcounts(ttp_thresh_slope_clean, max(max(ttp_thresh_slope_clean)) - min(min(ttp_thresh_slope_clean)) + 1);

        <span class="comment">%LineSpec Settings: line, marker, and colour</span>
        plot(min(min(ttp_thresh_slope_clean)):max(max(ttp_thresh_slope_clean)), h, <span class="string">'b'</span>);
        axis([0 numImages -inf inf]);
        title([name <span class="string">'Intensity Slope Histogram'</span>])
        ylabel(<span class="string">'Wells Turning On'</span>)
        xlabel(<span class="string">'Frame Number (2 per Minute)'</span>)
        <span class="keyword">if</span> imageSave == 1
            saveas(gcf,strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\Intensity_Slope_Hist'</span>),<span class="string">'png'</span>)
        <span class="keyword">end</span>

        figure(7)
        intensity_slope_cdfhandle = cdfplot(ttp_thresh_slope_clean);
        title([name <span class="string">' Intensity Slope CDF, '</span>, num2str(size(ttp_thresh_slope_clean,1)), <span class="string">' Wells'</span>])
        xlabel(<span class="string">'Frame Number (2 per Minute)'</span>)
        set(intensity_slope_cdfhandle, <span class="string">'LineStyle'</span>, <span class="string">'-'</span>, <span class="string">'Color'</span>, <span class="string">'r'</span>);

        <span class="keyword">if</span> imageSave == 1
            saveas(gcf,strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\Intensity_Slope_CDF'</span>),<span class="string">'png'</span>)
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%%PLOT HISTOGRAM AND CDF FOR WELLS THAT SLOPE ONLY THRESH</span>
    <span class="keyword">if</span> ttp_slopeOnly_clean &gt; 1
        figure(8)
        h=histcounts(ttp_slopeOnly_clean, max(max(ttp_slopeOnly_clean)) - min(min(ttp_slopeOnly_clean)) + 1);

        <span class="comment">%LineSpec Settings: line, marker, and colour</span>
        plot(min(min(ttp_slopeOnly_clean)):max(max(ttp_slopeOnly_clean)), h, <span class="string">'b'</span>);
        axis([0 numImages -inf inf]);
        title([name <span class="string">' Slope Histogram'</span>])
        ylabel(<span class="string">'Wells Turning On'</span>)
        xlabel(<span class="string">'Frame Number (2 per Minute)'</span>)
        <span class="keyword">if</span> imageSave == 1
            saveas(gcf,strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\Slope_Hist'</span>),<span class="string">'png'</span>)
        <span class="keyword">end</span>

        figure(9)
        slope_cdfhandle = cdfplot(ttp_slopeOnly_clean);
        title([name <span class="string">' Slope CDF, '</span>, num2str(size(ttp_slopeOnly_clean,1)), <span class="string">' Wells'</span>])
        xlabel(<span class="string">'Frame Number (2 per Minute)'</span>)
        set(slope_cdfhandle, <span class="string">'LineStyle'</span>, <span class="string">'-'</span>, <span class="string">'Color'</span>, <span class="string">'r'</span>);

        <span class="keyword">if</span> imageSave == 1
            saveas(gcf,strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\Slope_CDF'</span>),<span class="string">'png'</span>)
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
    <span class="comment">%SAVE TO EXCEL</span>

    <span class="comment">%SUMMARY FILE</span>
    <span class="comment">%TTP_hist: Contains the number of wells that turned on for each frame</span>
    <span class="comment">%fast_TTP_hist: Contains the number of wells that turned on after</span>
    <span class="comment">%   filtering by slope threshold</span>
    <span class="comment">%ttp: Lists time-to-positive for each tracked well that</span>
    <span class="comment">%   crosses the treshold</span>
    <span class="comment">%fast_ttp: Lists time-to-positive for each tracked well that</span>
    <span class="comment">%   crosses the treshold and slope threshold</span>
    <span class="comment">%maxSlope: Maximum slope/frame for each well</span>
    <span class="comment">%endIntensity: Final intensity (after baseline) for each well</span>
    <span class="comment">%wellArea: Area of each well</span>

    <span class="comment">%Total wells: Total wells detected on frame 1</span>
    <span class="comment">%Detected wells: number of wells detected on 2nd to last frame</span>
    <span class="comment">%Positive wells: number of detected wells that cross threshold</span>
    <span class="comment">%Fast slope pos wells: number of positive wells that cross slope threshold</span>

    minRows = numWells;
    <span class="keyword">if</span> numWells &lt; numImages
       minRows = numImages;
    <span class="keyword">end</span>

    col_header={<span class="string">'Intensity_ttp'</span>,<span class="string">'Intensity_hist'</span>, <span class="string">'Intensity_slope_ttp'</span>, <span class="string">'Intensity_slope_hist'</span>, <span class="string">'slope_ttp'</span>, <span class="string">'slope_hist'</span>,<span class="string">'maxSlope'</span>, <span class="string">'endIntensity'</span>, <span class="string">'wellArea'</span>, <span class="string">''</span>, <span class="string">''</span>};
    col1 = cell(minRows, 1); col1(1:size(ttp_thresh_clean,1),1) = num2cell(ttp_thresh_clean);
    col2 = cell(minRows, 1); col2(1:size(Intensity_Histogram,1),1) = num2cell(Intensity_Histogram);
    col3 = cell(minRows, 1); col3(1:size(ttp_thresh_slope_clean,1),1) = num2cell(ttp_thresh_slope_clean);
    col4 = cell(minRows, 1); col4(1:size(Intensity_Slope_Histogram,1),1) = num2cell(Intensity_Slope_Histogram);
    col5 = cell(minRows, 1); col5(1:size(ttp_slopeOnly_clean,1),1) = num2cell(ttp_slopeOnly_clean);
    col6 = cell(minRows, 1); col6(1:size(Slope_Histogram,1),1) = num2cell(Slope_Histogram);

    col7 = cell(minRows, 1); col7(1:size(fast_Slope,1),1) = num2cell(fast_Slope);
    col8 = cell(minRows, 1); col8(1:size(endIntensity,1),1) = num2cell(endIntensity);
    col9 = cell(minRows, 1); col9(1:size(wellArea,1),1) = num2cell(wellArea);
    col10= cell(minRows, 1); col10(1:18,1) = {<span class="string">'Total wells'</span>; <span class="string">'Detected wells'</span>; <span class="string">'Intensity wells'</span>; <span class="string">'Intensity slope wells'</span>; <span class="string">'slope wells'</span>;<span class="keyword">...</span>
        <span class="string">''</span>; <span class="string">'Settings'</span>; <span class="string">'frameAtTemp'</span>; <span class="string">'baselineStart'</span>; <span class="string">'baselineEnd'</span>; <span class="string">'areaLowBound'</span>; <span class="string">'areaHighBound'</span>;<span class="keyword">...</span>
        <span class="string">'majorAxisLowBound'</span>; <span class="string">'majorAxisHighBound'</span>; <span class="string">'threshold'</span>; <span class="string">'GaussWindow'</span>; <span class="string">'maxSlope'</span>; <span class="string">'maxSlopeThreshold'</span>};
    col11 = cell(minRows, 1); col11(1:18,1) = num2cell([totalNumWells; numWells; size(ttp_thresh_clean,1); size(ttp_thresh_slope_clean,1); size(ttp_slopeOnly_clean,1);<span class="keyword">...</span>
        0; 0;          frameAtTemp; baselineStart; baselineEnd; areaBound(1); areaBound(2);
        majorAxisBound(1); majorAxisBound(2); threshold; gaussWinSize; maxSlope; maxSlopeThreshold]);
    col11(6:7,1)={<span class="string">''</span>; <span class="string">''</span>};

    saveSummary = [col_header; col1 col2 col3 col4 col5 col6 col7 col8 col9 col10 col11];

    <span class="keyword">if</span> excelSaveSummary == 1
        disp(<span class="string">'Saving Summary Excel File'</span>)
        xlswrite(strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\'</span>,name,<span class="string">' Summary.xlsx'</span>), saveSummary)
    <span class="keyword">end</span>

    <span class="comment">%INTENSITY FILE</span>
    <span class="comment">%Total number of wells stored as the name of the sheet in Intensity</span>
    <span class="comment">%Intensity: raw traces for each tracked well</span>
    <span class="comment">%baselineData: traces after gaussian smoothing, baseline avg</span>
    <span class="comment">%subtraction and slope correction (if applicable).</span>
    <span class="keyword">if</span> excelSaveIntensity == 1
        disp(<span class="string">'Saving Intensity Excel File'</span>)
        xlswrite(strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\'</span>,name,<span class="string">' Intensity.xlsx'</span>), transpose(intensity), strcat(<span class="string">'Intensity_'</span>, num2str(totalNumWells)))
        xlswrite(strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\'</span>,name,<span class="string">' Intensity.xlsx'</span>), transpose(baselineData), <span class="string">'BaselineCorrected'</span>)
        xlswrite(strcat(saveHere, <span class="string">'Results_'</span>, name,<span class="string">'\'</span>,name,<span class="string">' Intensity.xlsx'</span>), transpose(baselineDiffData), <span class="string">'BaselineDerivative'</span>)
    <span class="keyword">end</span>

    disp(<span class="string">'Done Processing'</span>)
<span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2017a</a><br></p></div><!--
##### SOURCE BEGIN #####
clear;
close all;

%Automated analyzer for real-time isothermal amplification
%by Erik Jue, 2018

%This MATLAB script performs the following functions
%Loads a 12-bit .tif image sequence for digital LAMP experiment
%Uses first image frame (low temp) to detect total # wells
%Uses 2nd to last image frame (end of experiment) to detect positive wells
%Tracks the intensity of the positive wells over time
%Applies gaussian smoothing and baseline subtraction
%Saves the data
%Repeats for each tiff stack in the folder 

%Requires Bio-Formats 5.8.1 by OME
%https://www.openmicroscopy.org/bio-formats/
%Requires Control ZEN Blue and the microscope from MATLAB (ReadImage6D.m) by Sebastian Rhode
%https://www.mathworks.com/matlabcentral/fileexchange/50079-control-zen-blue-and-the-microscope-from-matlab?focused=6875595&tab=function

%Notes specific to this data set
%Used a connectivity of 4 (cardinal directions only) for well detection
%Ignore last frame since it does not capture the full exposure
%Sample fluorescence is high at low temp, use this to detect all wells
%Sample fluorescence decreases with high temp, ignore all heating frames 

%% VARIABLES FOR EDITING

%FOLDER TO ANALYZE, WILL ANALYZE ALL .TIF FILES IT FINDS
folder = 'Z:\Path\'; %'C:\user\data';

%SAVE LOCATION
saveHere = 'Z:\Path\'; %'C:\user\results\';

%Adds the trailing \ if applicable
if saveHere(end)~='\'
    saveHere = strcat(saveHere, '\');
end

%SETTINGS, 1 means on, 0 means off
%Set to 1 to save images
imageSave = 1;
%Set to 1 to save summary info to excel file
excelSaveSummary = 1;
%Set to 1 to save intensity curves to excel file
excelSaveIntensity = 1;

%baselineAdjust averages the intensities between all frames in between 
%baselineStart and baselineEnd and subtracts this value for all frames
%Set to 1 to enable background subtraction
baselineAdjust = 1;

%This is the frame number when the sample loses autofluorescence 
%(i.e. reaches the correct temp) A specific baseline end can be dictated 
%by altering 'baselineEnd'
frameAtTemp = 2;
baselineStart = frameAtTemp;
baselineEnd = 5;

%slopeAdjust finds the slope between the baselineEnd frame and
%baselineStart frame and propagates the slope correction for all frames
%This can be used to account for slow drift of negatives wells
%Note: do not use if raw data is very noisy
%Set to 1 to enable background slope correction
slopeAdjust = 0;

%Well Detection Settings
%Multi-level thresholding
%This techniques applies a threshold to detect a set of wells and selects
%selects wells that fall in the areaBound and majorAxisBound. Multiple
%rounds of different thresholds are applied to detect a greater number of
%wells

%Manually determined threshold levels for first image
im1_thresh = [.07 .08 .09 .1 .11 .12 .13 .14 .15 .175 .2 0.3 0.35 0.4 0.5];

%Manually determine threshold levels for the masking image
mask_thresh = [.05 .075 .1 .125 .15 .175 .2 .25 .3 .4];

%lower and upper cutoff for the area of each well
%Units in # of pixels
areaBound = [4 12];

%lower and upper cutoff for the major axis of each well (ensures circularity)
majorAxisBound = [2 5];

%Thresholding is used for automated time-to-positive determination
%Will calculate ttp after baselineAdjust and slopeAdjust if applicable
threshold = 500;

%A gaussian filter is used to smooth the intensity curves
%Set the gaussian window smoothing size
gaussWinSize = 5;

%Maximum allowable slope to detect
maxSlope = 200;

%Threshold for the max slope required to call a well positive
maxSlopeThreshold = 150;

%% PROGRAM START HERE

%Identify all the .tif files
myFiles = dir(fullfile(folder, '*.tif'));

%For each .tif, run image analysis
for a=1:size(myFiles,1)
    %Generate the specific file name
    baseFileName = myFiles(a).name;
    filename = fullfile(folder, baseFileName);
    
    %Load the image into memory
    tifStack=ReadImage6D(filename);
    disp(['Loaded ', filename])
    
    %The data file tifStack stores image info in {1} and metadata in {2}
    %Grab the metadata
    numImages = tifStack{2}.SizeZ;
    %For our images, %Y pixels are actually X pixels
    xpixels = tifStack{2}.SizeY; 
    ypixels = tifStack{2}.SizeX;
    
    %tifStack stores image info {1} in the format below
      %1 = Series
      %2 = SizeC
      %3 = SizeZ
      %4 = SizeT
      %5 = SizeX
      %6 = SizeY
    %Depending on how the .tif was generated, image # may be in slot 3 or 4

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %COUNT TOTAL WELLS USING 1ST IMAGE
    %Matlab does not natively support 12-bit, convert to 16-bit
    im1 = cast(16*squeeze(tifStack{1}(1,1,1,1,:,:)), 'uint16');
    
    %Detect all wells for the first image
    im1_bestMask = zeros(size(im1));
    for k = 1:size(im1_thresh,2)
        bwthresh = imbinarize(im1, im1_thresh(k));

        %Apply area filter
        areaFilter = bwpropfilt(bwthresh, 'Area', areaBound, 4);
        %Apply major axis filter
        majorAxisFilter = bwpropfilt(areaFilter, 'MajorAxisLength', majorAxisBound, 4);
        
        im1_bestMask = im1_bestMask + majorAxisFilter;
    end
    im1_bestMask = im1_bestMask~=0;
    
    %Calculate the total number of wells using the mask
    im1_result = bwconncomp(im1_bestMask, 4);
    totalNumWells = im1_result.NumObjects;
    
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %COUNT POSITIVE WELLS USING 2ND TO LAST IMAGE
    maskIm = cast(16*squeeze(tifStack{1}(1,1,numImages-1,1,:,:)), 'uint16');
    
    bestMask = zeros(size(im1));
    for k = 1:size(mask_thresh, 2)
        bwthresh = imbinarize(maskIm, mask_thresh(k));

        %Apply area filter
        areaFilter = bwpropfilt(bwthresh, 'Area', areaBound, 4);
        %Apply major axis filter
        majorAxisFilter = bwpropfilt(areaFilter, 'MajorAxisLength', majorAxisBound, 4);
        
        bestMask = bestMask + majorAxisFilter;
    end
    bestMask = bestMask~=0;

    %Generate the mask to use for all images
    labeledmask= bwconncomp(bestMask, 4);
    disp('Mask found, begin avg intensity calculations')

    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %FIND INTENSITY OF ALL POSITIVE WELLS OVER TIME
    
    %Call regionprops to count the number of positive wells
    resultTemp = regionprops(labeledmask, bestMask, 'MeanIntensity');
    numWells = size(resultTemp, 1);
    
    %Initialize matrix to track all intensity curves
    intensity = zeros(numImages-1, numWells);
    
    %Loop through all images and find the avg intensity of each well
    for i = 1:numImages-1
        if mod(i,10)==0
            disp(strcat('Calculating image #', num2str(i)))
        end

        current_im_u16 = cast(squeeze(tifStack{1}(1,1,i,1,:,:)), 'uint16');

        result = regionprops(labeledmask, current_im_u16, 'MeanIntensity', 'Area');
        intensity(i, :) = cat(1, result.MeanIntensity);
    end
    
    %Pull out the area for each well
    wellArea = zeros(numWells, 1);
    wellArea(:) = cat(1, result.Area);
    disp('All well intensities found')

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %DATA SMOOTHING, BKGND CORRECTION, AND SLOPE CORRECTION
    %Apply heuristically determined moving average window filter
    smooth = smoothdata(intensity, 'gaussian', gaussWinSize);

    %Background average subtraction
    baseline = zeros(1, numWells);
    baselineData = intensity;

    if baselineAdjust==1
        %Average the intensities between baselineStart and baselineEnd for
        %each well
        for i = 1:numWells
            baseline(i) = mean(smooth(baselineStart:baselineEnd, i));
        end
        
        %Subtract the baseline for each well
        for i = 1:numWells
            for j = 1:numImages-1
               baselineData(j,i) = smooth(j,i) - baseline(i); 
            end
        end
    end
    
    %Adjust the slope from baseline
    if slopeAdjust==1
        for i = 1:size(baselineData,1)
            slope = (baselineData(baselineEnd, i) - baselineData(baselineStart, i)) / (baselineEnd - baselineStart + 1);
            baselineSlope = linspace(0, (numImages-1)*slope, numImages);
            baselineSlope = baselineSlope - (((baselineEnd+baselineStart)/2)-1)*slope;

            baselineData(i, :) = baselineData(i, :) - baselineSlope(i);
        end
    end
    disp('Finished data smoothing')
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %DATA PROCESSING
    
    %Determine which wells cross the intensity threshold
    %Initialize an array to hold time-to-positive values for each well
    ttp_thresh = zeros(numWells,1 );

    %Do not count any time-to-positives before sample has reached temp
    for i=frameAtTemp:numImages-1
        for j=1:numWells
            %Record the first frame that a well crosses the threshold
            if (baselineData(i,j)>threshold && ttp_thresh(j)==0)
                ttp_thresh(j) = i;
            end
        end
    end
    
    %Generate new array that only contains wells that cross the threshold
    ttp_thresh_clean = ttp_thresh(ttp_thresh>0);
    
    %Generate array of number of wells on per frame
    Intensity_Histogram = zeros(numImages,1);
    for i=1:numImages
        Intensity_Histogram(i) = sum(ttp_thresh_clean(:)==i);
    end
    
    %Find the max slope for each well
    fast_Slope = zeros(numWells, 1);
    for p = 1:numWells
        fastestSlope = max(diff(baselineData(:,p)));
        %Ignores extremely high slopes that are imaging artifacts
        if fastestSlope < maxSlope
            fast_Slope(p) = fastestSlope;
        end
    end
    
    %Determine which wells cross the intensity AND slope thresholds
    ttp_thresh_slope = ttp_thresh(fast_Slope>maxSlopeThreshold);
    ttp_thresh_slope_clean = ttp_thresh_slope(ttp_thresh_slope>0);
    
    Intensity_Slope_Histogram = zeros(numImages, 1);
    for i=1:numImages
        Intensity_Slope_Histogram(i) = sum(ttp_thresh_slope_clean(:)==i);
    end
    
    %Determine which wells cross slope threshold
    baselineDiffData = diff(baselineData,1,1);
        
    ttp_slopeOnly = zeros(numWells,1);
    for q=frameAtTemp:numImages-2
        for r=1:numWells
            %Record the first frame that a well crosses the threshold
            if (baselineDiffData(q,r)>maxSlopeThreshold && ttp_slopeOnly(r)==0)
                ttp_slopeOnly(r) = q;
            end
        end
    end
    
    %Generate new array that only contains wells that cross the threshold
    ttp_slopeOnly_clean = ttp_slopeOnly(ttp_slopeOnly>0);
    
    Slope_Histogram = zeros(numImages-1, 1);
    for i=1:numImages-1
        Slope_Histogram(i) = sum(ttp_slopeOnly_clean(:)==i);
    end
    
    %Find the max intensity of each positive well
    endIntensity = zeros(numWells, 1);
    for m = 1:numWells
        endIntensity(m) = (baselineData(numImages-1,m));
    end

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %SAVE DATA
    %Break the filename into parts
    [filepath, name, ext] = fileparts(filename);
    
    %Create a folder to save the results
    if imageSave == 1
        disp('Saving Images')
        mkdir(strcat(saveHere, 'Results_', name));
    end
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %Plot the generation of the masks
    figure(1)
    subplot(2,2,1);
    imshow(im1);
    title('First Image')
    
    subplot(2,2,2);
    imshow(im1_bestMask);
    title('Well Counting')
    
    subplot(2,2,3);
    imshow(maskIm);
    title('Masking Image')
    
    subplot(2,2,4);
    imshow(bestMask);
    title('Final Mask')
    
    if imageSave == 1
        saveas(gcf,strcat(saveHere, 'Results_', name,'\Thresholding'),'png')
    end

    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%Plot baselined intensities over time
    figure(2)
    
    %Downsample here to shown fewer curves
    plot(baselineData(:, :)); 
    
    %Set the plot axes
    axis([0 numImages -100 1000]);
    title([name ' Corrected Well Intensity']);
    xlabel('Frame Number (2 per minute)');
    ylabel('RFU');
    
    if imageSave == 1
        saveas(gcf,strcat(saveHere, 'Results_', name,'\BaselineIntensity'),'png')
    end
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%Plot derivative of baseline over time
    figure(3)
    
    %Downsample here to shown fewer curves
    plot(baselineDiffData(:, :)); 
    
    %Set the plot axes
    axis([0 numImages -30 200]);
    title([name ' Corrected Derivative']);
    xlabel('Frame Number (2 per minute)');
    ylabel('Delta RFU');
    
    if imageSave == 1
        saveas(gcf,strcat(saveHere, 'Results_', name,'\BaselineDeriv'),'png')
    end
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%PLOT HISTOGRAM AND CDF FOR WELLS THAT CROSS INTENSITY THRESH
    
    %Only plot if the are wells that turned positive. 
    if ttp_thresh_clean > 1    
        figure(4)
        h=histcounts(ttp_thresh_clean, max(max(ttp_thresh_clean)) - min(min(ttp_thresh_clean)) + 1);

        %LineSpec Settings: line, marker, and colour
        plot(min(min(ttp_thresh_clean)):max(max(ttp_thresh_clean)), h, 'b');
        axis([0 numImages -inf inf]);
        title([name ' Intensity Histogram'])
        ylabel('Wells Turning On')
        xlabel('Frame Number (2 per Minute)')
        if imageSave == 1
            saveas(gcf,strcat(saveHere, 'Results_', name,'\Intensity_Hist'),'png')
        end
        
        %%Plot ttp CDF
        figure(5)
        intensity_cdfhandle = cdfplot(ttp_thresh_clean);  
        title([name ' Intensity CDF, ', num2str(size(ttp_thresh_clean,1)), ' Wells'])
        xlabel('Frame Number (2 per Minute)')
        set(intensity_cdfhandle, 'LineStyle', '-', 'Color', 'r');
        
        if imageSave == 1
            saveas(gcf,strcat(saveHere, 'Results_', name,'\Intensity_CDF'),'png')
        end
    end
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%PLOT HISTOGRAM AND CDF FOR WELLS THAT CROSS INTENSITY AND SLOPE THRESH
    if ttp_thresh_slope_clean > 1    
        figure(6)
        h=histcounts(ttp_thresh_slope_clean, max(max(ttp_thresh_slope_clean)) - min(min(ttp_thresh_slope_clean)) + 1);

        %LineSpec Settings: line, marker, and colour
        plot(min(min(ttp_thresh_slope_clean)):max(max(ttp_thresh_slope_clean)), h, 'b');
        axis([0 numImages -inf inf]);
        title([name 'Intensity Slope Histogram'])
        ylabel('Wells Turning On')
        xlabel('Frame Number (2 per Minute)')
        if imageSave == 1
            saveas(gcf,strcat(saveHere, 'Results_', name,'\Intensity_Slope_Hist'),'png')
        end
        
        figure(7)
        intensity_slope_cdfhandle = cdfplot(ttp_thresh_slope_clean);  
        title([name ' Intensity Slope CDF, ', num2str(size(ttp_thresh_slope_clean,1)), ' Wells'])
        xlabel('Frame Number (2 per Minute)')
        set(intensity_slope_cdfhandle, 'LineStyle', '-', 'Color', 'r');

        if imageSave == 1
            saveas(gcf,strcat(saveHere, 'Results_', name,'\Intensity_Slope_CDF'),'png')
        end
    end
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%PLOT HISTOGRAM AND CDF FOR WELLS THAT SLOPE ONLY THRESH
    if ttp_slopeOnly_clean > 1    
        figure(8)
        h=histcounts(ttp_slopeOnly_clean, max(max(ttp_slopeOnly_clean)) - min(min(ttp_slopeOnly_clean)) + 1);

        %LineSpec Settings: line, marker, and colour
        plot(min(min(ttp_slopeOnly_clean)):max(max(ttp_slopeOnly_clean)), h, 'b');
        axis([0 numImages -inf inf]);
        title([name ' Slope Histogram'])
        ylabel('Wells Turning On')
        xlabel('Frame Number (2 per Minute)')
        if imageSave == 1
            saveas(gcf,strcat(saveHere, 'Results_', name,'\Slope_Hist'),'png')
        end
        
        figure(9)
        slope_cdfhandle = cdfplot(ttp_slopeOnly_clean);  
        title([name ' Slope CDF, ', num2str(size(ttp_slopeOnly_clean,1)), ' Wells'])
        xlabel('Frame Number (2 per Minute)')
        set(slope_cdfhandle, 'LineStyle', '-', 'Color', 'r');

        if imageSave == 1
            saveas(gcf,strcat(saveHere, 'Results_', name,'\Slope_CDF'),'png')
        end
    end
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %SAVE TO EXCEL

    %SUMMARY FILE
    %TTP_hist: Contains the number of wells that turned on for each frame
    %fast_TTP_hist: Contains the number of wells that turned on after
    %   filtering by slope threshold
    %ttp: Lists time-to-positive for each tracked well that
    %   crosses the treshold
    %fast_ttp: Lists time-to-positive for each tracked well that
    %   crosses the treshold and slope threshold
    %maxSlope: Maximum slope/frame for each well
    %endIntensity: Final intensity (after baseline) for each well
    %wellArea: Area of each well

    %Total wells: Total wells detected on frame 1
    %Detected wells: number of wells detected on 2nd to last frame
    %Positive wells: number of detected wells that cross threshold
    %Fast slope pos wells: number of positive wells that cross slope threshold
    
    minRows = numWells;
    if numWells < numImages
       minRows = numImages; 
    end
    
    col_header={'Intensity_ttp','Intensity_hist', 'Intensity_slope_ttp', 'Intensity_slope_hist', 'slope_ttp', 'slope_hist','maxSlope', 'endIntensity', 'wellArea', '', ''};
    col1 = cell(minRows, 1); col1(1:size(ttp_thresh_clean,1),1) = num2cell(ttp_thresh_clean);
    col2 = cell(minRows, 1); col2(1:size(Intensity_Histogram,1),1) = num2cell(Intensity_Histogram);
    col3 = cell(minRows, 1); col3(1:size(ttp_thresh_slope_clean,1),1) = num2cell(ttp_thresh_slope_clean);
    col4 = cell(minRows, 1); col4(1:size(Intensity_Slope_Histogram,1),1) = num2cell(Intensity_Slope_Histogram);
    col5 = cell(minRows, 1); col5(1:size(ttp_slopeOnly_clean,1),1) = num2cell(ttp_slopeOnly_clean);
    col6 = cell(minRows, 1); col6(1:size(Slope_Histogram,1),1) = num2cell(Slope_Histogram);
    
    col7 = cell(minRows, 1); col7(1:size(fast_Slope,1),1) = num2cell(fast_Slope);
    col8 = cell(minRows, 1); col8(1:size(endIntensity,1),1) = num2cell(endIntensity);
    col9 = cell(minRows, 1); col9(1:size(wellArea,1),1) = num2cell(wellArea);
    col10= cell(minRows, 1); col10(1:18,1) = {'Total wells'; 'Detected wells'; 'Intensity wells'; 'Intensity slope wells'; 'slope wells';...
        ''; 'Settings'; 'frameAtTemp'; 'baselineStart'; 'baselineEnd'; 'areaLowBound'; 'areaHighBound';...
        'majorAxisLowBound'; 'majorAxisHighBound'; 'threshold'; 'GaussWindow'; 'maxSlope'; 'maxSlopeThreshold'};
    col11 = cell(minRows, 1); col11(1:18,1) = num2cell([totalNumWells; numWells; size(ttp_thresh_clean,1); size(ttp_thresh_slope_clean,1); size(ttp_slopeOnly_clean,1);...
        0; 0;          frameAtTemp; baselineStart; baselineEnd; areaBound(1); areaBound(2);
        majorAxisBound(1); majorAxisBound(2); threshold; gaussWinSize; maxSlope; maxSlopeThreshold]);
    col11(6:7,1)={''; ''};

    saveSummary = [col_header; col1 col2 col3 col4 col5 col6 col7 col8 col9 col10 col11];

    if excelSaveSummary == 1
        disp('Saving Summary Excel File')
        xlswrite(strcat(saveHere, 'Results_', name,'\',name,' Summary.xlsx'), saveSummary)
    end 

    %INTENSITY FILE
    %Total number of wells stored as the name of the sheet in Intensity
    %Intensity: raw traces for each tracked well
    %baselineData: traces after gaussian smoothing, baseline avg
    %subtraction and slope correction (if applicable).
    if excelSaveIntensity == 1
        disp('Saving Intensity Excel File')
        xlswrite(strcat(saveHere, 'Results_', name,'\',name,' Intensity.xlsx'), transpose(intensity), strcat('Intensity_', num2str(totalNumWells)))
        xlswrite(strcat(saveHere, 'Results_', name,'\',name,' Intensity.xlsx'), transpose(baselineData), 'BaselineCorrected')
        xlswrite(strcat(saveHere, 'Results_', name,'\',name,' Intensity.xlsx'), transpose(baselineDiffData), 'BaselineDerivative')
    end 

    disp('Done Processing')
end
##### SOURCE END #####
--></body></html>